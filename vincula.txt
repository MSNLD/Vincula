Vincula v3.6 - eXonyte's MSN Chat connection script

Date: June 19, 2002

-----------------------------------------------------------------------

Requires mIRC 6.x, only tested in 6.01. Should work in 6.02.
WILL NOT work in mIRC 5.91 or lower.

If you are using a script or addon that changes the way mIRC displays
any events, especially a theme system, then Vincula will likely
conflict with it.  MTS engine support may be added at a future date to
correct this, or the display events can be modified at will.

-----------------------------------------------------------------------

v3.6 - What's new:
- nHTMLn had an unofficial update at http://www.mircscripts.org that
  fixes it for mIRC 6.x, so I added alot of nHTMLn related features.
- Changed "View Profile" so that it displays it in mIRC directly
  instead of opening an Internet Explorer window.
- Made the /msn.getpp auto passport grabber even more automatic. All
  you need to do now is use the command, sign in to your passport, and
  Vincula handles the rest.
- Added /msn.roomlist command and "View MSN Room List..." popup. Opens
  an nHTMLn window in mIRC to one of the categories on MSN, and when
  you click a link on the page Vincula will join the room
  automatically. See the section below for /msn.roomlist for a
  description of everything this command allows.
- Fixed an exploit that could result in your being "moofed" from MSN.
- Added an "Extra Options" tab to the /msn.setup dialog that includes a
  few extra options (more to come in the future):
  - Time Reply changing (you can use %vars and $identifiers in it)
  - Show user's profile type when they join a room
- Fixed a bug where the Random Font Color option wasn't being set right

For old What's New lists, see the end of this file.

-----------------------------------------------------------------------

Make sure vincula.mrc and nHTMLn_2.9.dll are in the same folder, and
then load ONLY vincula.mrc into mIRC.  If you don't know how to load a
script, then in mIRC type:

//load -rs " $+ $sfile(*.mrc) $+ "

in any mIRC window and choose vincula.mrc from the list, from
whatever folder you had previously unzipped it to.

You will get a message saying that the script has been loaded, and then
it will perform various one-time initialization steps.  It will also
tell you your current UserData1 key, and finish by opening the script
options dialog, which can be reopened any time by typing: /msn.setup

You will also need to load your passport info on a daily basis, unless
you always use Guest mode.  This process is described below.

For the most part, this script can be controlled by popups and dialogs,
you can access anything important by right-clicking and choosing the
items in the "Vincula" menu.  You can also choose some things from the
mIRC Command menu at the top, in between DCC and Window, in the
"Vincula" submenu.

-----------------------------------------------------------------------

To load your passport information so that you can connect through
passport:

The easiest way is to click the Refresh Passport button in the Vincula
Options dialog, or choose "Update Passport information" from one of the
Vincula menus (either in the Status window, or in the mIRC menubar).

The rest all very simple to figure out, it's just like logging in to a
normal MSN Chat room, but for those who would like an explanation:

Vincula will scan your Internet Explorer cache for a moment, and then
it will open a window that asks for you to sign in to your passport.

All you need to do is enter your login information, and it will sign in
to the MSN room called TheLobby.

Before the room is even displayed (unless perhaps you have a very fast
computer), it will Logout of your passport, close the window, and then
it will say whether your passport update was successful or not.

For the curious, all Vincula is doing while scanning the cache, is it
is making sure it reads the file that contains your current passport
info, and not a file that contains outdated info.

-----------------------------------------------------------------------

The manual way to update your passport info, if the simple method
doesn't work, is as follows:

Go to http://chat.msn.com and join any room (even one that doesn't
exist).

Once the page opens, right-click on the page and choose View Source.

Hopefully it opens the View Source in Notepad, and once it's open
just save it wherever you like.

Now, back in mIRC, type:

/msn.mgetpp

and choose the file you just saved.

It should scan through the file and say that it found the passport
info.

-----------------------------------------------------------------------

Joining a room:

After issuing any of the below room-join commands, the script will ask
you for a nickname.  This DOES allow you to use almost any nickname you
desire.  If you want to use a unicode name, make sure you check the box
that says "Name is in Unicode format."  If you are using plain ASCII in
the name (such as directly typing Alt+0169 to get ©), then leave the
box unchecked.  Also, if you leave the name entry box blank, Vincula
will use an appropriate default nickname, either the Passport's own
nickname or your current nickname with Guest_ (mIRC will show this as
> instead of Guest_) added on to it.

/msn %#RoomName [key]
---------------------
Joins a room using the loaded passport info.  If you supply a key, it
will use this key when joining.

/msn -g %#RoomName [key]
------------------------
Joins a room using a Guest nickname (you will be asked for a name).
If you use -c instead of -g, it will join a Community Room

/joinurl [-g] http://chat.msn.com... [key]
------------------------------------------
Joins the room based on the address for the room.  If you want to join
in Guest mode, use -g just like in the /msn command.
If you use -c instead of -g, it will join a Community Room, though in
this case it's not very practical, since it won't understand a
community room's URL.


/joinhex [-g] 2523526F6F6D4E616D65 [key]
----------------------------------------
Joins a room via the hex name.  Use -g to join as a Guest.
If you use -c instead of -g, it will join a Community Room

/joins [-g|-k key|-gk key] Room Name
------------------------------------
Joins a room that has spaces in the name.
You can use either -g, -k, or both. -g of course joins as a Guest. -k
allows you to use a key, like this:
/joins -k somekey My Chat Room
That would join the room "My Chat Room" using the key "somekey". If you
want to combine -g and -k, just type it as either -gk or -kg and
include the key, for example:
/joins -gk somekey My Chat Room
If you use -c instead of -g, it will join a Community Room

-----------------------------------------------------------------------

Other commands:

/msn.setup
----------
Lets you set the font that MSN users will see, along with a bunch of
other options for the script (including those below).  If you want to
use a font that's not on the list just type the name in, Vincula
doesn't care.

On the General tab:
Decode incoming text:
    Passes most incoming messages through the script's Unicode decoder
    so that names and text which use special characters can be read.
Show users' colors:
    Allows you to see what colors people are speaking in, and also if
    they are using Bold and/or Underlined text.  Because of an mIRC
    limitation, you cannot see Italics, nor specific fonts.
Auto password usage:
    Vincula automatically stores any Ownerkey that it sees, whether it
    is from you creating a room, or it was someone else setting it in
    a room you were an owner in.  This option tells Vincula to use the
    key that it has stored whenever you join a room.
Encode outgoing text:
    This option will encode any outgoing text, so that MSN Chat users
    will actually be able to see any special characters you type, such
    as † or §.
Profile Dropbox:
    Makes MSN Chat users see one of the the little profile icons next
    to your name in the room's user list.  This icon is the little guy
    or girl that you may have seen next to people's names on MSN Chat.

On the Extra Options tab:
Time Reply:
    Lets you change the time reply that people get when they check your
    local time.  You can use $identifiers and %variables if you like.
    The default button restores the time reply to match MSN Chat's.
Show user's profile type upon entry:
    When someone enters the room, Vincula will check what type of
    profile they have and tell you right below the Join message.
    
/msn.roomlist
-------------
Allows you to view the MSN Chat Room list for any of the categories.
When you click a link to a room, Vincula will ask you how to join the
room. You can choose to join through Vincula, either using your
passport or as a guest, or you can join using the MSN Chat Control,
either as a guest or using the passport info that is stored in Vincula.
You can only have one MSN Chat window open at a time though or there
will likely be problems. Also, if a room link is too long then you
can't click it to join it. This is due to an apparent nHTMLn or mIRC
limitation and there's nothing I can do about it. I suggest you right
click and choose Copy Shortcut, and then use /joinurl to join the room
through Vincula.


/msn.getpass <room>
-------------------
Displays the last stored password of <room> and also copies it to the
clipboard.

/msn.geturl <room>
------------------
Displays the URL for <room> and also copies it to the clipboard.

/msn.getpp
----------
Use this to update your passport info, according to the instructions
that are above.

/msn.mgetpp
-----------
Use this to update your passport info the old way, also according to
instructions given above.

/msn.editpp
-----------
Opens a dialog so that you can edit your passport information, or enter
it manually.

/access
-------
In addition to setting access levels and such, you can type this
command alone to open the Access List dialog for whatever room you type
it in.

/msncolor <on|off>
------------------
Makes the script show you what colors the people are using to speak,
also shows bold and underlined text. Does not show Italic, or the
actual font. It's off by default, just because it bugs me.
This option can also be changed from /msn.setup on a per-room basis.

/msndebug <on|off>
------------------
This is more of a developer command for me, it's really not of much use
to anyone else.  It opens a window and shows you all of the data that
passes through the script.

/msndecode <on|off>
-------------------
Turns on or off the incoming text decoder. It's on by default.
To turn it off:
/msndecode off
This option can also be changed from /msn.setup on a per-room basis.

/msnencode <on|off>
-------------------
Turns on or off the outgoing text encoder. It's off by default.
To turn it on:
/msnencode on
This option can also be changed from /msn.setup on a per-room basis.

/pass [password]
----------------
Works just like the /pass in MSN Chat.  Allows you to use a room's host
or owner keys to make yourself a host (+o) or owner (+q). If the
password is not supplied, it will open a small dialog to ask for it.

/msn.updatefonts
----------------
Not recommended to use often, but this will allow you to update the
font name cache, which is useful if you have added or deleted any fonts
since you loaded this script.

-----------------------------------------------------------------------

Custom Identifiers:

$msn.decode(text)
-----------------
Returns text, as passed through the script's Unicode decoder. Most
useful for Unicode nicknames.

$msn.encode(text)
-----------------
Returns text, as passed through the script's Unicode encoder. Most
useful for using extended ascii characters (Alt codes) in speaking and
in nicknames.

$msn.pass / $msn.pass(N)
------------------------
Makes a randomly generated password N characters long. If N is not
supplied, it will create an eight character password.

$msn.roompass / $msn.roompass(%#room)
-------------------------------------
Returns the stored room owner key for the active channel (if used in
the editbox without %#room), or the owner key for for %#room.

$msn.tohex(text)
----------------
Returns text in hexadecimal format.

$msn.ud1
--------
Returns the current MSN Chat UserData1 entry from the registry. The MSN
Chat Control uses this entry to set a room key when you create a new
room through the MSN Chat website.  Vincula generates a random key and
does not use the UserData1 in any way.

$msn.unhex(hex)
---------------
Returns a hexadecimal number in ASCII format.

$joinurl(url)
-------------
Extracts the room hex from a URL, even if the URL does not have the hex
for the room in it.

-----------------------------------------------------------------------

A few comments for MSN scripters:

The socket names are:

msn.server. $+ $cid <-- MSN Server

msn.mirc. $+ $cid   <-- mIRC

If you would prefer to send something to every socket, then just use
msn.server.* or msn.mirc.* or if you're really daring, msn.*

To get the room name for a socket, use:  $msn.get($sockname,room)
You can also use $msn.get($cid,room)

Unlike most scripts, this script converts WHISPER commands into
standard IRC PRIVMSG commands, and vice-versa. It also converts NOTICE
into PRIVMSG and back.  Basically, what this means for you is that you
can use a simple "on *:TEXT:*:?:" to trigger a whisper event, instead
of having to use "raw whisper:*:".  Just a little trick to make your
life easier.

For those who would be interested in changing how Vincula will display
all the events (such as messages, kicks, topic changes, etc.), you may
edit that part of the script as long as you don't mess anything up in
the process.  I won't be able to help you if you screwed up something,
so you'd just have to reinstall the original version of the script and
start over.

-----------------------------------------------------------------------

Extra information:

Real Name: Brandon A.
Nickname: eXonyte
E-mail: exonyte1@exonyte.dyndns.org

Official Website: http://exonyte.dyndns.org

I'd like to thank my testers: Trad, Moto, Atti, and Neo. To anyone else
that I sent a copy of this thing to and forgot about: Sorry! Let me
know and I'll put your name in here too!

Why Vincula?
Vincula is a plural form of Vinculum, which means "A bond or tie."
Since the nature of this script is multiple "ties" to MSN Chat, I think
the name fits it well.

If you would like to include this MSN connection addon with your own
script, I only ask that it remain completely unmodified, except for the
text display events at the beginning of the script as was mentioned in
the above section.

This addon contains a few things that I did not write:

URL Decoder by Techster
Available at: http://www.mircscripts.org/comments.php?id=1225

Truetype Font Attribute reader by Kamek
Available at: http://www.mircscripts.org/comments.php?id=1341

The COM Registry Reading identifier was also written by someone else
but I found it on a message board somewhere, and they claimed they got
it from the mircscripts.org Web Board.  If someone can claim ownership
of the code, please let me know.

The nHTMLn DLL is © 2001 Necroman
Available at: http://www.wot.net/~necroman/nn2.htm
Unofficially Updated to version 2.91 by Dan

-----------------------------------------------------------------------

Old What's New lists:

v3.5 - What's new:
- The filename will from now on just be "vincula.mrc" so that you can
  just close mIRC, replace the file, and reopen mIRC, to upgrade.
- Added more characters to the text decoder.
- Fixed a bug in the MSN Color support that was causing dark gray and
  blue to display wrongly.
- Added a Passport Info editor, in case you prefer to manually extract
  your passport info, or you want to edit it for some reason. To open
  the dialog use /msn.editpp or choose "Passport Info Editor" from a
  popup menu.
- Changed the "Force View Profile" menu popup to "View Profile Type"
  and changed the way that the "View Profile" popup works in order to
  support the new Male/Female/Picture profile icons in MSN Chat 4.2.
- Improved the passport grabber, it's now practically automatic.
  The old method is still available as:  /msn.mgetpp
- Changed the way the encoder works.  Now will only encode what you
  actually say so that it doesn't interfere with scripts that use the
  $nick identifier, and it won't interfere with any other /commands.
- Added a dialog that can be used for handling the /access list. To
  open the dialog, open it from the Vincula menu, or type:  /access
  This will NOT interfere with using the /access command in any way.
- Changed the Join URL dialogs (the ones accessible by menus), so that
  they properly say "URL" instead of "Hex."
- Made the font scanner attempt to autodetect the font folder, so that
  there's less chance for the user to pick the wrong folder.
- Added a timer for room joining, so that you can see how long it takes
  to get into a room.
- The Vincula menu in channels and on the nickname list will now only
  show up in MSN connection windows. If you are connected to a normal
  IRC room, the Vincula menu will be hidden.
- Fixed the /unload command if you tried to load it in a version older
  than 6.0, it was missing a -rs
- Probably a couple of other small things that I just forgot to write
  down in here.
- Fixed any other bugs I came across, either by info from others or by
  my own experimenting and testing.

v3.4 - Initial release